---
title: "HiCAGE: Hi-C Annotation and Graphics Ensemble"
author: "Michael J. Workman and Dennis J. Hazelett"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    number_sections: true
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{HiCAGE}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction
The `HiCAGE` (Hi-C Annotation and Plotting Software) package offers users the 
ability to annotate and visualize 3C-based genomic data at whole-genome scale. 
This document describes the functionalities of the package and provides users 
with detailed descriptions on its use. 

# Package Overview
`HiCAGE` has a variety of features designed for efficient annotation, analysis, 
and visualization of interacting chromatin regions. 

## HiCAGE Environment Setup
`HiCAGE` requires the following packages to be installed:
```{r message = FALSE, warning = FALSE}
library(GenomicRanges)
library(circlize)
library(biomaRt)
library(HiCAGE)
library(topGO)
```

## Input Data
`HiCAGE` is designed to handle tab-delimited data as input. 3C-based genomic 
data, segmentation data, and RNA-seq data can all be input. RNA-seq data, 
however, is optional. Files can be in *txt*, *tsv*, *bed*, or other formats. 
`HiCAGE` is written to require the least amount of data manipulation prior to 
loading files by allowing the user to specify the columns containing the 
necessary data from each data file. Default column selection is setup to handle 
common data layouts. 
  
- Example Hi-C data files: GEO Accession: 
[GSE63525](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE63525)
- Segmentation data files: *[StateHub/StatepaintR](http://statehub.org/statehub/)*
- Example RNA-seq data files: GEO Accession: 
[GSE78557](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE78557)
or processed [tsv format](https://www.encodeproject.org/experiments/ENCSR000AEM/)

# Code
Example format for initial data input:
```{r message = FALSE, results= 'hide'}
hic_chr20 <- system.file("extdata", "hic_chr20.txt", package = "HiCAGE")
segment_chr20 <- system.file("extdata", "segment_chr20.bed", package = "HiCAGE")
rna_chr20 <- system.file("extdata", "rna_chr20.tsv", package = "HiCAGE")

example <- overlap(hicfile = hic_chr20, 
                   segmentfile = segment_chr20, 
                   rnafile = rna_chr20,
                   bio_mart = "ensembl",
                   martset = "hsapiens_gene_ensembl",
                   webhost = "http://Feb2014.archive.ensembl.org")
```

## Column Selection *(Optional based on data format)*
### Hi-C or 3C-based Data Column Selection
Example Hi-C data file:
```{r echo = FALSE, tidy = TRUE}
head(read.table(file = hic_chr20, comment.char = "#", skip = 1))
```

Hi-C data files need to contain the columns in the following example:

Chrom1 | Chrom1Start | Chrom1End | Chrom2 | Chrom2Start | Chrom2End | Score
------ | ----------- | --------- | ------ | ----------- | --------- | -----
 "V1"  |     "V2"    |    "V3"   |  "V4"  |     "V5"    |    "V6"   |  "V8"
 20    | 13300000    | 13310000  | 20     | 13520000    | 13530000  | 35
 20    | 17520000    | 17530000  | 20     | 17590000    | 17600000  | 71

The default `overlap` function selects these columns automatically. If columns 
are not is this order, user can use `hic.columns` to select the proper columns:

```{r eval = FALSE}
overlap(hicfile = hic_chr20, 
        segmentfile = segment_chr20, 
        rnafile = rna_chr20,
        hic.columns = c(1:6, 8))
```

### Segmentation File Column Selection
Example *StateHub/StatePaintR* segmentation data file:
```{r echo = FALSE, tidy = TRUE}
head(read.table(file = segment_chr20, comment.char = "#", skip = 1))
```

Segmentation data files need to contain the columns in the following example:

Chrom | ChromStart | ChromEnd | Mark | Score 
----- | ---------- | -------- | ---- | ----- 
 "V1" | "V2"       | "V3"     | "V4" | "V5" 
chr20 | 62218      | 62675    | EWR  | 0.0000
chr20 | 117995     | 118433   | HET  | 781.1476

*StateHub/StatePaintR* segmentation files all use the above format. However, 
users can still select columns containing the necessary information using
`segment.column` in the `overlap` function:

```{r eval = FALSE}
overlap(hicfile = hic_chr20, 
        segmentfile = segment_chr20, 
        rnafile = rna_chr20,
        segment.columns = c(1:5))
```

### RNA-seq Data File Column Selection
Example RNA-seq data file:
```{r echo = FALSE, tidy = TRUE}
head(read.table(file = rna_chr20, comment.char = "#", skip = 1))
```

RNA-seq data files need to contain only Ensembl gene ID and gene expression 
data. User can decide to use FPKM or TPM at their discretion:

Ensembl ID        | FPKM | 
----------        | ---- | 
 "V1"             | "V7" | 
ENSG00000249139.1 | 0    | 
ENSG00000158901.7 | 0    | 


User can select columns in the RNA-seq data file using `rna.column` in the 
`overlap` function:

```{r eval = FALSE}
overlap(hicfile = hic_chr20, 
        segmentfile = segment_chr20, 
        rnafile = rna_chr20,
        rna.columns = c(1, 7))
```

## biomaRt Selection
`HiCAGE` enables users to select various biomaRts using the `biomaRt` package,
allowing for flexibility in species and genome build for annotating 
genomic regions. Default genome selection is `"hsapiens_gene_ensembl"`. Genome 
selection must match the genome used to compile the 3C-based data file. 

The biomaRt can be specified in the `overlap` function and will be passed
on to the `biomaRt` package

```{r eval = FALSE}
overlap <- function(hicfile,
                    segmentfile,
                    rnafile,
                    bio_mart = "ensembl",
                    martset = "hsapiens_gene_ensembl",
                    webhost = "www.ensembl.org")
```

###Sample of available datasets in the "ensembl" Mart:

dataset	                  |	description	                   |	version
---------	                |	---------	                     |	--------
hsapiens_gene_ensembl   	|	Human genes                    |	GRCh38.p7
mmusculus_gene_ensembl  	|	Mouse genes                    |	GRCm38.p5
rnorvegicus_gene_ensembl  |	Rat genes                      |	Rnor_6.0
dmelanogaster_gene_ensembl|	Fruitfly genes                 |	BDGP6
scerevisiae_gene_ensembl	|	Saccharomyces cerevisiae genes |	R64-1-1
celegans_gene_ensembl	    |	Caenorhabditis elegans genes   |	WBcel235
ocuniculus_gene_ensembl	  |	Rabbit genes                   |	OryCun2.0
xtropicalis_gene_ensembl	|	Xenopus genes                  |	JGI 4.2
drerio_gene_ensembl      	|	Zebrafish genes                |	GRCz10


###Currently available datasets in the "ENSEMBL_MART_MOUSE" Mart:

dataset	                |	description	           |	version
---------	              |	---------	             |	------
mwsbeij_gene_ensembl    |	Mouse WSBEiJ genes     | WSB_EiJ_v1
mc3hhej_gene_ensembl	  |	Mouse C3HHeJ genes     | C3H_HeJ_v1
mc57bl6nj_gene_ensembl	|	Mouse C57BL6NJ genes   | C57BL_6NJ_v1
mnzohlltj_gene_ensembl  |	Mouse NZOHlLtJ genes   | NZO_HlLtJ_v1
mpwkphj_gene_ensembl    |	Mouse PWKPhJ genes     | PWK_PhJ_v1
mfvbnj_gene_ensembl	    |	Mouse FVBNJ genes      | FVB_NJ_v1
mcbaj_gene_ensembl      |	Mouse CBAJ genes       | CBA_J_v1
mcasteij_gene_ensembl	  |	Mouse CASTEiJ genes    | CAST_EiJ_v1
mlpj_gene_ensembl	      |	Mouse LPJ genes        | LP_J_v1
makrj_gene_ensembl	    |	Mouse AKRJ genes       | AKR_J_v1
mbalbcj_gene_ensembl	  |	Mouse BALBcJ genes     | BALB_cJ_v1
mnodshiltj_gene_ensembl	|	Mouse NODShiLtJ genes  | NOD_ShiLtJ_v1
m129s1svimj_gene_ensembl|	Mouse 129S1SvImJ genes | 129S1_SvImJ_v1
mspreteij_gene_ensembl	|	Mouse SPRETEiJ genes 	 | SPRET_EiJ_v1
mdba2j_gene_ensembl	    |	Mouse DBA2J genes      | DBA_2J_v1
maj_gene_ensembl	      |	Mouse AJ genes         | A_J_v1

###Currently available datasets in the "ENSEMBL_MART_MOUSE" Mart:
```{r}
ensembl <- useMart("ENSEMBL_MART_MOUSE")
listDatasets(ensembl)

```

###Available archived versions of Ensembl

```{r}
listEnsemblArchives()
```

# Data Output
## `overlap` Data Output
Data from the `overlap` function is output as a GRanges object. The GRanges 
object is anchored using the first chromosome and range. All other information
is stored as metadata

```{r echo = FALSE}
head(example)
```

## `gogenelist` Data Output
The `gogenelist` function allows the user to conveniently select a chromatin 
mark of interest (proximalmark) interacting with another chromatin mark 
(distalmark) and generates an ordered list of all genes and expression data 
associated with the proximalmark.

```{r}
gogenelist(datafile = example,
           proximalmark = "PAR",
           distalmark = "EAR",
           gene.symbol = FALSE,
           species = "human",
           bio_mart = "ensembl",
           martset = "hsapiens_gene_ensembl",
           webhost = "http://Feb2014.archive.ensembl.org",
           geneOnto = FALSE,
           expression_cutoff = 0)
```


# Figures

```{r fig.height = 6, fig.width = 6, fig.align = "center", fig.cap = "Figure output from HiCAGE circleplot function"}
circleplot(datatable = example, display.legend = TRUE)
```

